<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Fila de Chamados - Payhub</title>
    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* Estilos otimizados */
        :root {
            --sp-blue: #0078d4;
            --sp-blue-dark: #106ebe;
            --sp-green: #107c10;
            --sp-yellow: #ffb900;
            --sp-red: #d13438;
            --sp-orange: #ca5010;
            --sp-gray-light: #f3f2f1;
            --sp-gray-medium: #edebe9;
            --sp-gray-dark: #323130;
            --sp-text-primary: #323130;
            --sp-text-secondary: #605e5c;
            --sp-background: #faf9f8;
            --sp-surface: #ffffff;
            --sp-purple: #9b59b6;
            --sp-cyan: #00bcd4;
            --sp-loading: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', sans-serif;
        }
        
        body {
            background-color: var(--sp-background);
            color: var(--sp-text-primary);
            line-height: 1.5;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--sp-surface);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 24px;
            border: 1px solid var(--sp-gray-medium);
        }
        
        /* Header */
        .header {
            border-bottom: 2px solid var(--sp-blue);
            padding-bottom: 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content {
            flex: 1;
        }
        
        .header h1 {
            color: var(--sp-blue);
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header p {
            color: var(--sp-text-secondary);
            font-size: 14px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background-color: var(--sp-gray-light);
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* Painel de tempo */
        .time-panel {
            background: linear-gradient(135deg, var(--sp-blue) 0%, var(--sp-blue-dark) 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .time-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .time-text {
            display: flex;
            flex-direction: column;
        }
        
        .time-date {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .time-clock {
            font-size: 20px;
            font-weight: 600;
        }
        
        .simulation-indicator {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Grid principal */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Cards */
        .card {
            background: var(--sp-surface);
            border: 1px solid var(--sp-gray-medium);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: box-shadow 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--sp-text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--sp-gray-light);
        }
        
        /* Item de analista */
        .analyst-card {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            align-items: center;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            background-color: var(--sp-gray-light);
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        
        .analyst-card.active {
            background-color: #e6f7ff;
            border-color: var(--sp-blue);
            box-shadow: 0 2px 8px rgba(0, 120, 212, 0.2);
        }
        
        .analyst-card.next {
            background-color: #fff9e6;
            border-color: var(--sp-yellow);
        }
        
        .analyst-card.busy {
            background-color: #fef5e7;
            border-color: var(--sp-orange);
        }
        
        .analyst-card.waiting-client {
            background-color: #e6f3ff;
            border-color: var(--sp-cyan);
        }
        
        .analyst-card.offline {
            background-color: #f8f9fa;
            color: var(--sp-text-secondary);
            border: 1px dashed var(--sp-gray-medium);
        }
        
        .analyst-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .analyst-name {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .analyst-level {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: var(--sp-blue);
            color: white;
            font-weight: 600;
        }
        
        .analyst-level.n1 {
            background-color: var(--sp-blue);
        }
        
        .analyst-level.n2 {
            background-color: var(--sp-purple);
        }
        
        .analyst-schedule {
            font-size: 13px;
            color: var(--sp-text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .ticket-info {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 6px;
            color: var(--sp-text-primary);
            font-weight: 600;
            border-left: 3px solid var(--sp-blue);
        }
        
        .ticket-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .ticket-status.aguardando {
            background-color: var(--sp-cyan);
            color: white;
        }
        
        .ticket-status.atendendo {
            background-color: var(--sp-orange);
            color: white;
        }
        
        .ticket-number {
            color: var(--sp-blue);
            font-weight: 700;
        }
        
        .analyst-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-available {
            background-color: var(--sp-green);
        }
        
        .status-busy {
            background-color: var(--sp-orange);
        }
        
        .status-waiting {
            background-color: var(--sp-cyan);
        }
        
        .status-offline {
            background-color: var(--sp-red);
        }
        
        .ticket-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        /* Status buttons */
        .status-buttons {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        
        .status-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        .status-btn.waiting {
            background-color: var(--sp-cyan);
            color: white;
        }
        
        .status-btn.resume {
            background-color: var(--sp-green);
            color: white;
        }
        
        .status-btn.finish {
            background-color: var(--sp-red);
            color: white;
        }
        
        /* Inputs */
        .input-field {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--sp-gray-medium);
            border-radius: 6px;
            font-size: 14px;
            color: var(--sp-text-primary);
            background-color: white;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--sp-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }
        
        select.input-field {
            cursor: pointer;
        }
        
        /* Botões */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            height: 36px;
            background-color: var(--sp-blue);
            color: white;
            border: 1px solid transparent;
        }
        
        .btn:hover {
            background-color: var(--sp-blue-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background-color: var(--sp-green);
        }
        
        .btn-success:hover {
            background-color: #0c6c0c;
        }
        
        .btn-warning {
            background-color: var(--sp-yellow);
            color: var(--sp-text-primary);
        }
        
        .btn-warning:hover {
            background-color: #e6a700;
        }
        
        .btn-danger {
            background-color: var(--sp-red);
        }
        
        .btn-danger:hover {
            background-color: #c02a2e;
        }
        
        .btn-purple {
            background-color: var(--sp-purple);
        }
        
        .btn-purple:hover {
            background-color: #8e44ad;
        }
        
        .btn-cyan {
            background-color: var(--sp-cyan);
        }
        
        .btn-cyan:hover {
            background-color: #0097a7;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            height: 28px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
            background-color: var(--sp-blue);
        }
        
        /* Painel de estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--sp-surface);
            border: 1px solid var(--sp-gray-medium);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--sp-blue);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--sp-text-secondary);
        }
        
        /* Painel de controles */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* Clientes especiais */
        .special-client {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            background-color: #f0f7ff;
            border-left: 4px solid var(--sp-blue);
        }
        
        .client-info {
            display: flex;
            flex-direction: column;
        }
        
        .client-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--sp-text-primary);
        }
        
        .assigned-analyst {
            background-color: var(--sp-blue);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Modais */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--sp-surface);
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--sp-gray-medium);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--sp-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--sp-text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .close-modal:hover {
            background-color: var(--sp-gray-light);
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }
        
        /* Notificações */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--sp-green);
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
        }
        
        .notification.warning {
            background-color: var(--sp-yellow);
            color: var(--sp-text-primary);
        }
        
        .notification.error {
            background-color: var(--sp-red);
        }
        
        .notification.info {
            background-color: var(--sp-blue);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Footer */
        .footer {
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid var(--sp-gray-medium);
            text-align: center;
            color: var(--sp-text-secondary);
            font-size: 13px;
        }
        
        .last-reset {
            margin-top: 8px;
            font-style: italic;
            color: var(--sp-text-secondary);
        }
        
        /* Indicador de carregamento */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            color: var(--sp-text-secondary);
            font-size: 14px;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--sp-gray-medium);
            border-top-color: var(--sp-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Status Firebase */
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--sp-gray-dark);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 100;
        }
        
        .firebase-status.connected {
            background-color: var(--sp-green);
        }
        
        .firebase-status.disconnected {
            background-color: var(--sp-red);
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 16px;
            }
            
            .analyst-card {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .ticket-controls {
                flex-direction: row;
                justify-content: center;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 22px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .time-panel {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho -->
        <div class="header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-headset"></i>
                    Portal de Fila de Chamados - Payhub
                </h1>
                <p>Sistema de gerenciamento de atendimento da equipe N1/N2</p>
            </div>
            <div class="user-info" id="userInfo">
                <i class="fas fa-user"></i>
                <span id="userName">Carregando...</span>
            </div>
        </div>
        
        <!-- Painel de tempo -->
        <div class="time-panel">
            <div class="time-info">
                <i class="fas fa-clock" style="font-size: 24px;"></i>
                <div class="time-text">
                    <div class="time-date" id="currentDate">Carregando data...</div>
                    <div class="time-clock" id="currentTime">Carregando hora...</div>
                </div>
            </div>
            <div id="simulationIndicator" class="simulation-indicator" style="display: none;">
                <i class="fas fa-magic"></i>
                Horário simulado
            </div>
        </div>
        
        <!-- Grid principal -->
        <div class="main-grid">
            <!-- Fila de atendimento -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-list-ol"></i>
                    Fila de Atendimento - N1
                </div>
                <div id="queueList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <span>Conectando ao banco de dados...</span>
                    </div>
                </div>
            </div>
            
            <!-- Clientes especiais -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-star"></i>
                    Clientes Especiais
                </div>
                <div id="specialCases">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <span>Carregando...</span>
                    </div>
                </div>
                
                <!-- Informações -->
                <div style="margin-top: 24px; padding: 16px; background-color: var(--sp-gray-light); border-radius: 8px;">
                    <div style="font-weight: 600; color: var(--sp-text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-info-circle"></i>
                        Como funciona
                    </div>
                    <ul style="list-style-type: none; padding-left: 0; font-size: 13px; color: var(--sp-text-secondary);">
                        <li style="margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: var(--sp-green); margin-top: 2px;"></i>
                            <span>Clientes especiais são direcionados automaticamente</span>
                        </li>
                        <li style="margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px;">
                            <i class="fas fa-sync-alt" style="color: var(--sp-blue); margin-top: 2px;"></i>
                            <span>Eric participa da fila normal exceto para casos TIM</span>
                        </li>
                        <li style="display: flex; align-items: flex-start; gap: 8px;">
                            <i class="fas fa-history" style="color: var(--sp-yellow); margin-top: 2px;"></i>
                            <span>Fila reinicia após 7 chamados ou no dia seguinte</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Estatísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalTickets">0</div>
                <div class="stat-label">Chamados Hoje</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeAnalysts">0</div>
                <div class="stat-label">Analistas Ativos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="nextInQueue">-</div>
                <div class="stat-label">Próximo na Fila</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="specialTickets">0</div>
                <div class="stat-label">Casos Especiais</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="waitingTickets">0</div>
                <div class="stat-label">Aguardando Cliente</div>
            </div>
        </div>
        
        <!-- Painel de controles -->
        <div class="controls-grid">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-plus-circle"></i>
                    Novo Chamado
                </div>
                <div class="control-group">
                    <input type="text" id="newTicketNumber" class="input-field" placeholder="Número do chamado (ou deixe em branco para gerar automático)">
                    <select id="ticketType" class="input-field">
                        <option value="normal">Chamado Normal</option>
                        <option value="TIM">Cliente TIM (Eric)</option>
                        <option value="DPSP">Cliente DPSP (Tamiris)</option>
                        <option value="Benoit">Cliente Benoit (André)</option>
                    </select>
                    <button class="btn btn-success" id="addTicketBtn" disabled>
                        <i class="fas fa-plus"></i>
                        Adicionar Chamado
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-cogs"></i>
                    Controles da Fila
                </div>
                <div class="control-group">
                    <button class="btn" id="nextAnalystBtn" disabled>
                        <i class="fas fa-forward"></i>
                        Próximo Analista
                    </button>
                    <button class="btn btn-warning" id="resetQueueBtn" disabled>
                        <i class="fas fa-redo-alt"></i>
                        Reiniciar Fila do Dia
                    </button>
                    <button class="btn btn-danger" id="freeAllBtn" disabled>
                        <i class="fas fa-user-check"></i>
                        Liberar Todos
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-clock"></i>
                    Simulação de Horário
                </div>
                <div class="control-group">
                    <button class="btn" id="simulateTimeBtn" disabled>
                        <i class="fas fa-magic"></i>
                        Simular Horário
                    </button>
                    <button class="btn btn-warning" id="realTimeBtn" style="display: none;" disabled>
                        <i class="fas fa-clock"></i>
                        Voltar ao Horário Real
                    </button>
                    <div class="last-reset" id="lastResetInfo"></div>
                </div>
            </div>
            
            <!-- Novo card para relatórios CSV -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-file-csv"></i>
                    Relatórios CSV
                </div>
                <div class="control-group">
                    <button class="btn btn-cyan" id="generateReportBtn" disabled>
                        <i class="fas fa-download"></i>
                        Gerar Relatório CSV
                    </button>
                    <div class="last-reset" id="reportInfo" style="font-size: 12px;">
                        Conecte-se para gerar relatórios
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rodapé -->
        <div class="footer">
            <p><strong>Portal de Fila de Chamados - Equipe Payhub</strong> | Desenvolvido para uso interno</p>
            <p>Última atualização: <span id="lastUpdate">--:--:--</span></p>
            <p class="last-reset">Fila reiniciada em: <span id="lastResetDate"></span></p>
        </div>
    </div>
    
    <!-- Modal para simulação de horário -->
    <div id="timeSimulationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-clock"></i>
                    Simular Horário
                </div>
                <button class="close-modal" id="closeTimeModal">&times;</button>
            </div>
            
            <p style="margin-bottom: 20px; color: var(--sp-text-secondary); font-size: 14px;">
                Selecione um horário para simular o comportamento da fila:
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;">
                <button class="btn time-option" data-hour="7">7:00</button>
                <button class="btn time-option" data-hour="8">8:00</button>
                <button class="btn time-option" data-hour="9">9:00</button>
                <button class="btn time-option" data-hour="10">10:00</button>
                <button class="btn time-option" data-hour="14">14:00</button>
                <button class="btn time-option" data-hour="18">18:00</button>
                <button class="btn time-option" data-hour="22">22:00</button>
                <button class="btn time-option" data-hour="23">23:00</button>
            </div>
            
            <div style="background-color: var(--sp-gray-light); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: var(--sp-text-primary); margin-bottom: 12px;">Horários de Expediente:</div>
                <div style="font-size: 13px; color: var(--sp-text-secondary); display: flex; flex-direction: column; gap: 6px;">
                    <div><i class="far fa-clock" style="width: 16px;"></i> 8h-17h: Eric, Jonathan</div>
                    <div><i class="far fa-clock" style="width: 16px;"></i> 9h-18h: Carolina, Cristiane, Tamiris</div>
                    <div><i class="far fa-clock" style="width: 16px;"></i> 14h-23h: Sander, Yan</div>
                    <div><i class="far fa-clock" style="width: 16px;"></i> 8h-18h: André, Felipe (N2)</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-danger" id="cancelSimulation">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-success" id="applySimulation">
                    <i class="fas fa-check"></i>
                    Aplicar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para gerar relatório CSV -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-file-csv"></i>
                    Gerar Relatório CSV
                </div>
                <button class="close-modal" id="closeReportModal">&times;</button>
            </div>
            
            <p style="margin-bottom: 20px; color: var(--sp-text-secondary); font-size: 14px;">
                Selecione o período para gerar o relatório de chamados:
            </p>
            
            <div class="control-group" style="margin-bottom: 24px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--sp-text-primary);">
                        <i class="fas fa-calendar-day"></i> Data Inicial
                    </label>
                    <input type="date" id="startDate" class="input-field">
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--sp-text-primary);">
                        <i class="fas fa-calendar-day"></i> Data Final
                    </label>
                    <input type="date" id="endDate" class="input-field">
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; margin-top: 16px;">
                    <input type="checkbox" id="includeAllTickets" style="width: 18px; height: 18px;">
                    <label for="includeAllTickets" style="font-size: 14px; color: var(--sp-text-secondary);">
                        Incluir todos os chamados (incluindo em andamento)
                    </label>
                </div>
            </div>
            
            <div style="background-color: var(--sp-gray-light); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: var(--sp-text-primary); margin-bottom: 12px;">
                    <i class="fas fa-info-circle"></i> Informações do Relatório
                </div>
                <ul style="list-style-type: none; padding-left: 0; font-size: 13px; color: var(--sp-text-secondary);">
                    <li style="margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: var(--sp-green); margin-top: 2px;"></i>
                        <span>Exporta dados do Firebase Firestore</span>
                    </li>
                    <li style="margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px;">
                        <i class="fas fa-columns" style="color: var(--sp-blue); margin-top: 2px;"></i>
                        <span>Colunas: Número do Chamado, Analista, Data de Atendimento, Status</span>
                    </li>
                    <li style="display: flex; align-items: flex-start; gap: 8px;">
                        <i class="fas fa-cloud" style="color: var(--sp-purple); margin-top: 2px;"></i>
                        <span>Dados são salvos automaticamente na nuvem</span>
                    </li>
                </ul>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-danger" id="cancelReport">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-success" id="generateCSV">
                    <i class="fas fa-download"></i>
                    Gerar e Baixar CSV
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de login -->
    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-sign-in-alt"></i>
                    Login - Portal de Chamados
                </div>
            </div>
            
            <p style="margin-bottom: 20px; color: var(--sp-text-secondary); font-size: 14px;">
                Faça login para acessar o sistema de fila de chamados:
            </p>
            
            <div class="control-group" style="margin-bottom: 24px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--sp-text-primary);">
                        <i class="fas fa-envelope"></i> E-mail
                    </label>
                    <input type="email" id="loginEmail" class="input-field" placeholder="seu.email@payhub.com.br">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--sp-text-primary);">
                        <i class="fas fa-lock"></i> Senha
                    </label>
                    <input type="password" id="loginPassword" class="input-field" placeholder="Sua senha">
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                    <input type="checkbox" id="rememberMe" style="width: 18px; height: 18px;" checked>
                    <label for="rememberMe" style="font-size: 14px; color: var(--sp-text-secondary);">
                        Manter conectado
                    </label>
                </div>
            </div>
            
            <div style="background-color: var(--sp-gray-light); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: var(--sp-text-primary); margin-bottom: 12px;">
                    <i class="fas fa-users"></i> Acesso Restrito
                </div>
                <div style="font-size: 13px; color: var(--sp-text-secondary);">
                    Este sistema é de uso exclusivo da equipe Payhub. 
                    Entre em contato com o administrador para criar uma conta.
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-success" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    Entrar
                </button>
            </div>
            
            <div id="loginError" style="margin-top: 16px; padding: 12px; background-color: #fef5e7; border-radius: 6px; display: none;">
                <div style="color: var(--sp-orange); font-size: 13px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="loginErrorMessage"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Status do Firebase -->
    <div id="firebaseStatus" class="firebase-status">
        <i class="fas fa-plug"></i>
        <span>Conectando...</span>
    </div>

    <script>
        // ============================================
        // CONFIGURAÇÃO DO FIREBASE
        // ============================================
        
        // SUAS CONFIGURAÇÕES DO FIREBASE AQUI
const firebaseConfig = {
  apiKey: "AIzaSyCJXxaG8R5-VmkoGA7PyFcyfcvBAk92yTc",
  authDomain: "portal-fila-payhub.firebaseapp.com",
  projectId: "portal-fila-payhub",
  storageBucket: "portal-fila-payhub.firebasestorage.app",
  messagingSenderId: "28871537008",
  appId: "1:28871537008:web:38d6ac22721f40a7d61fb5"
};

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ============================================
        // CONFIGURAÇÃO DOS ANALISTAS
        // ============================================
        
        const analysts = [
            { 
                id: 1, 
                name: "Eric", 
                level: "N1", 
                startTime: 8, 
                endTime: 17, 
                isAvailable: false, 
                isBusy: false,
                currentTicket: null,
                ticketStatus: null,
                specialClient: "TIM",
                inQueue: true,
                ticketsHandled: 0
            },
            { 
                id: 2, 
                name: "Carolina", 
                level: "N1", 
                startTime: 9, 
                endTime: 18, 
                isAvailable: false, 
                isBusy: false,
                currentTicket: null,
                ticketStatus: null,
                specialClient: null,
                inQueue: true,
                ticketsHandled: 0
            },
            { 
                id: 3, 
                name: "Tamiris", 
                level: "N1", 
                startTime: 9, 
                endTime: 18, 
                isAvailable: false, 
                isBusy: false,
                currentTicket: null,
                ticketStatus: null,
                specialClient: "DPSP",
                inQueue: true,
                ticketsHandled: 0
            },
            { 
                id: 4, 
                name: "Cristiane", 
                level: "N1", 
                startTime: 9, 
                endTime: 18, 
                isAvailable: false, 
                isBusy: false,
                currentTicket: null,
                ticketStatus: null,
                specialClient: null,
                inQueue: true,
                ticketsHandled: 0
            },
            { 
                id: 5, 
                name: "Jonathan", 
                level: "N1", 
                startTime: 8, 
                endTime: 17, 
                isAvailable: false, 
                isBusy: false,
                currentTicket: null,
                ticketStatus: null,
                specialClient: null,
                inQueue: true,
                ticketsHandled: 0
            },
            { 
                id: 6, 
                name: "Sander", 
                level: "N1", 
                startTime: 14, 
                endTime: 23, 
                isAvailable: false, 
                isBusy: false,
                currentTicket: null,
                ticketStatus: null,
                specialClient: null,
                inQueue: true,
                ticketsHandled: 0
            },
            { 
                id: 7, 
                name: "Yan", 
                level: "N1", 
                startTime: 14, 
                endTime: 23, 
                isAvailable: false, 
                isBusy: false,
                currentTicket: null,
                ticketStatus: null,
                specialClient: null,
                inQueue: true,
                ticketsHandled: 0
            },
            { 
                id: 8, 
                name: "André", 
                level: "N2", 
                startTime: 8, 
                endTime: 18, 
                isAvailable: false, 
                isBusy: false,
                currentTicket: null,
                ticketStatus: null,
                specialClient: "Benoit",
                inQueue: false,
                ticketsHandled: 0
            },
            { 
                id: 9, 
                name: "Felipe", 
                level: "N2", 
                startTime: 8, 
                endTime: 18, 
                isAvailable: false, 
                isBusy: false,
                currentTicket: null,
                ticketStatus: null,
                specialClient: null,
                inQueue: false,
                ticketsHandled: 0
            }
        ];

        const specialClients = [
            { client: "Benoit", analyst: "André", level: "N2" },
            { client: "TIM", analyst: "Eric", level: "N1" },
            { client: "DPSP", analyst: "Tamiris", level: "N1" }
        ];

        // Estado da aplicação
        let state = {
            currentAnalystIndex: 0,
            ticketsToday: 0,
            specialTicketsToday: 0,
            waitingTicketsToday: 0,
            lastReset: new Date().toLocaleDateString('pt-BR'),
            queueOrder: [],
            lastUpdate: new Date().toLocaleTimeString('pt-BR'),
            simulatedTime: null,
            nextTicketNumber: 1000,
            dailyResetDone: false,
            user: null,
            isOnline: false
        };

        // ============================================
        // INICIALIZAÇÃO DA APLICAÇÃO
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            initializeFirebase();
            
            // Atualizar a cada minuto
            setInterval(updateApp, 60000);
        });

        function initializeApp() {
            updateCurrentTime();
            updateLastUpdateTime();
            setupReportDates();
        }

        function setupEventListeners() {
            // Botões principais
            document.getElementById('addTicketBtn').addEventListener('click', handleNewTicket);
            document.getElementById('nextAnalystBtn').addEventListener('click', nextAnalyst);
            document.getElementById('resetQueueBtn').addEventListener('click', resetQueue);
            document.getElementById('freeAllBtn').addEventListener('click', freeAllAnalysts);
            document.getElementById('simulateTimeBtn').addEventListener('click', openTimeSimulationModal);
            document.getElementById('realTimeBtn').addEventListener('click', returnToRealTime);
            
            // Botões de relatório
            document.getElementById('generateReportBtn').addEventListener('click', openReportModal);
            document.getElementById('closeReportModal').addEventListener('click', closeReportModal);
            document.getElementById('cancelReport').addEventListener('click', closeReportModal);
            document.getElementById('generateCSV').addEventListener('click', generateCSVReport);
            
            // Modal de simulação
            document.getElementById('closeTimeModal').addEventListener('click', closeTimeSimulationModal);
            document.getElementById('cancelSimulation').addEventListener('click', closeTimeSimulationModal);
            document.getElementById('applySimulation').addEventListener('click', applyTimeSimulation);
            
            // Login
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            // Opções de horário no modal
            document.querySelectorAll('.time-option').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.time-option').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Permitir Enter no campo de número do chamado
            document.getElementById('newTicketNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleNewTicket();
                }
            });
        }

        // ============================================
        // FIREBASE - INICIALIZAÇÃO E AUTENTICAÇÃO
        // ============================================
        
        function initializeFirebase() {
            updateFirebaseStatus('Conectando ao Firebase...', false);
            
            // Monitorar estado de conexão
            db.enableNetwork().then(() => {
                state.isOnline = true;
                updateFirebaseStatus('Conectado', true);
                
                // Verificar autenticação persistente
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        handleAuthSuccess(user);
                    } else {
                        showLoginModal();
                    }
                });
            }).catch((error) => {
                console.error('Erro de conexão Firebase:', error);
                updateFirebaseStatus('Desconectado', false);
                showNotification('Erro de conexão com o banco de dados', 'error');
            });
        }

        function updateFirebaseStatus(message, isConnected) {
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.innerHTML = `<i class="fas fa-${isConnected ? 'plug' : 'unlink'}"></i><span>${message}</span>`;
            statusElement.className = `firebase-status ${isConnected ? 'connected' : 'disconnected'}`;
            state.isOnline = isConnected;
            
            // Habilitar/desabilitar botões baseado na conexão
            const buttons = ['addTicketBtn', 'nextAnalystBtn', 'resetQueueBtn', 'freeAllBtn', 
                           'simulateTimeBtn', 'generateReportBtn', 'realTimeBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = !isConnected || !state.user;
                }
            });
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('loginError').style.display = 'none';
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (!email || !password) {
                showLoginError('Preencha e-mail e senha');
                return;
            }
            
            const persistence = rememberMe ? 
                firebase.auth.Auth.Persistence.LOCAL : 
                firebase.auth.Auth.Persistence.SESSION;
            
            auth.setPersistence(persistence)
                .then(() => {
                    return auth.signInWithEmailAndPassword(email, password);
                })
                .then((userCredential) => {
                    handleAuthSuccess(userCredential.user);
                })
                .catch((error) => {
                    console.error('Erro de login:', error);
                    let errorMessage = 'Erro ao fazer login';
                    
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMessage = 'E-mail inválido';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'Usuário desativado';
                            break;
                        case 'auth/user-not-found':
                            errorMessage = 'Usuário não encontrado';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Senha incorreta';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Muitas tentativas. Tente novamente mais tarde';
                            break;
                    }
                    
                    showLoginError(errorMessage);
                });
        }

        function showLoginError(message) {
            const errorElement = document.getElementById('loginError');
            const errorMessage = document.getElementById('loginErrorMessage');
            errorMessage.textContent = message;
            errorElement.style.display = 'block';
        }

        function handleAuthSuccess(user) {
            state.user = {
                uid: user.uid,
                email: user.email,
                name: user.displayName || user.email.split('@')[0]
            };
            
            updateUserInfo();
            hideLoginModal();
            showNotification(`Bem-vindo, ${state.user.name}!`, 'success');
            
            // Carregar dados do Firestore
            loadFirebaseData();
            
            // Habilitar botões
            updateFirebaseStatus('Conectado', true);
        }

        function updateUserInfo() {
            document.getElementById('userName').textContent = state.user.name;
        }

        function logout() {
            auth.signOut().then(() => {
                state.user = null;
                showLoginModal();
                showNotification('Você saiu do sistema', 'info');
            });
        }

        // ============================================
        // FIREBASE - OPERAÇÕES DO BANCO DE DADOS
        // ============================================
        
        async function loadFirebaseData() {
            if (!state.user || !state.isOnline) return;
            
            try {
                // Carregar estado atual
                const stateDoc = await db.collection('systemState').doc('current').get();
                if (stateDoc.exists) {
                    const data = stateDoc.data();
                    Object.assign(state, data);
                    
                    // Carregar dados dos analistas
                    const analystsSnapshot = await db.collection('analysts').get();
                    analystsSnapshot.forEach(doc => {
                        const data = doc.data();
                        const analyst = analysts.find(a => a.id === data.id);
                        if (analyst) {
                            Object.assign(analyst, data);
                        }
                    });
                    
                    updateAnalystAvailability();
                    updateQueueOrder();
                    updateQueueDisplay();
                    updateSpecialCasesDisplay();
                    updateStatistics();
                    
                    showNotification('Dados carregados do Firebase', 'success');
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showNotification('Erro ao carregar dados do banco', 'error');
            }
        }

        async function saveFirebaseState() {
            if (!state.user || !state.isOnline) return;
            
            try {
                // Salvar estado do sistema
                await db.collection('systemState').doc('current').set({
                    ...state,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: state.user.email
                });
                
                // Salvar dados dos analistas
                for (const analyst of analysts) {
                    await db.collection('analysts').doc(analyst.id.toString()).set({
                        ...analyst,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                console.log('Estado salvo no Firebase');
            } catch (error) {
                console.error('Erro ao salvar estado:', error);
            }
        }

        async function saveTicketToFirebase(ticketNumber, analystName, status = 'finalizado') {
            if (!state.user || !state.isOnline) return;
            
            try {
                const ticketData = {
                    ticketNumber: ticketNumber,
                    analyst: analystName,
                    date: new Date().toISOString().split('T')[0],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: status,
                    simulatedDate: state.simulatedTime ? state.simulatedTime.toISOString().split('T')[0] : null,
                    createdBy: state.user.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('tickets').add(ticketData);
                console.log('Ticket salvo no Firebase:', ticketNumber);
                
                // Atualizar contador de tickets hoje
                await updateTodayTicketsCount();
                
            } catch (error) {
                console.error('Erro ao salvar ticket:', error);
                // Fallback para localStorage
                saveToLocalStorage(ticketNumber, analystName, status);
            }
        }

        async function updateTodayTicketsCount() {
            if (!state.user || !state.isOnline) return;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const ticketsRef = db.collection('tickets');
                const query = ticketsRef.where('date', '==', today);
                const snapshot = await query.get();
                
                state.ticketsToday = snapshot.size;
                await saveFirebaseState();
                
            } catch (error) {
                console.error('Erro ao contar tickets:', error);
            }
        }

        async function getTicketsByDateRange(startDate, endDate, includeAll = false) {
            if (!state.user || !state.isOnline) {
                throw new Error('Sem conexão com o banco de dados');
            }
            
            try {
                const ticketsRef = db.collection('tickets');
                let query = ticketsRef
                    .where('timestamp', '>=', new Date(startDate))
                    .where('timestamp', '<=', new Date(endDate + 'T23:59:59.999Z'))
                    .orderBy('timestamp', 'desc');
                
                const snapshot = await query.get();
                const tickets = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tickets.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
                
                // Filtrar por status se necessário
                if (!includeAll) {
                    return tickets.filter(ticket => ticket.status === 'finalizado');
                }
                
                return tickets;
                
            } catch (error) {
                console.error('Erro ao buscar tickets:', error);
                throw error;
            }
        }

        // Fallback para localStorage
        function saveToLocalStorage(ticketNumber, analystName, status) {
            try {
                const history = JSON.parse(localStorage.getItem('ticketHistory') || '[]');
                const ticketRecord = {
                    id: Date.now(),
                    ticketNumber,
                    analyst: analystName,
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    status,
                    simulatedDate: state.simulatedTime ? state.simulatedTime.toISOString().split('T')[0] : null
                };
                
                history.push(ticketRecord);
                if (history.length > 1000) history = history.slice(-1000);
                localStorage.setItem('ticketHistory', JSON.stringify(history));
                
            } catch (e) {
                console.error('Erro ao salvar no localStorage:', e);
            }
        }

        // ============================================
        // FUNÇÕES PRINCIPAIS (ATUALIZADAS PARA FIREBASE)
        // ============================================
        
        function updateCurrentTime() {
            const now = state.simulatedTime ? new Date(state.simulatedTime) : new Date();
            
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('pt-BR', dateOptions);
            const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('currentDate').textContent = dateString;
            document.getElementById('currentTime').textContent = timeString;
            
            const simulationIndicator = document.getElementById('simulationIndicator');
            const realTimeBtn = document.getElementById('realTimeBtn');
            
            if (state.simulatedTime) {
                simulationIndicator.style.display = 'inline-flex';
                realTimeBtn.style.display = 'block';
            } else {
                simulationIndicator.style.display = 'none';
                realTimeBtn.style.display = 'none';
            }
            
            updateAnalystAvailability();
        }

        function updateAnalystAvailability() {
            const now = state.simulatedTime ? new Date(state.simulatedTime) : new Date();
            const currentHour = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTime = currentHour + currentMinutes / 100;
            
            analysts.forEach(analyst => {
                const startTime = analyst.startTime;
                const endTime = analyst.endTime;
                
                analyst.isAvailable = (currentTime >= startTime && currentTime < endTime);
                
                if (analyst.ticketStatus === 'aguardando-cliente') {
                    analyst.isBusy = false;
                } else if (analyst.ticketStatus === 'atendendo' || analyst.currentTicket) {
                    analyst.isBusy = true;
                }
                
                if (analyst.name === "Eric" && analyst.currentTicket === "TIM") {
                    analyst.isBusy = true;
                    analyst.isAvailable = false;
                }
                
                if (analyst.name === "Tamiris" && analyst.currentTicket === "DPSP") {
                    analyst.isBusy = true;
                    analyst.isAvailable = false;
                }
                
                if (analyst.name === "André" && analyst.currentTicket === "Benoit") {
                    analyst.isBusy = true;
                    analyst.isAvailable = false;
                }
            });
            
            updateQueueOrder();
            updateQueueDisplay();
            updateSpecialCasesDisplay();
            updateStatistics();
            saveFirebaseState();
        }

        // ... (as funções updateQueueOrder, updateQueueDisplay, createAnalystCardHTML, etc. permanecem as mesmas, mas agora chamam saveFirebaseState)

        function assignTicketToAnalyst(analystId, ticketNumber, ticketType, ticketStatus = 'atendendo') {
            const analyst = analysts.find(a => a.id === analystId);
            
            if (!analyst) return;
            
            analyst.isBusy = ticketStatus === 'atendendo';
            analyst.currentTicket = ticketNumber;
            analyst.ticketStatus = ticketStatus;
            
            if (ticketType !== 'normal') {
                const clientName = getClientNameFromTicket(ticketType);
                if (analyst.specialClient === clientName) {
                    analyst.currentTicket = clientName;
                }
            }
            
            analyst.ticketsHandled++;
            
            if (analyst.name === "Eric" && ticketType === "TIM") {
                analyst.inQueue = false;
            }
            
            if (analyst.name === "Tamiris" && ticketType === "DPSP") {
                analyst.inQueue = false;
            }
            
            // Salvar no Firebase
            saveTicketToFirebase(ticketNumber, analyst.name, 'iniciado');
            
            updateQueueOrder();
            updateQueueDisplay();
            updateSpecialCasesDisplay();
            updateStatistics();
        }

        function finishTicket(analystId) {
            const analyst = analysts.find(a => a.id === analystId);
            
            if (!analyst) return;
            
            const ticketNumber = analyst.currentTicket;
            
            // Salvar no Firebase
            if (ticketNumber) {
                saveTicketToFirebase(ticketNumber, analyst.name, 'finalizado');
            }
            
            analyst.isBusy = false;
            analyst.currentTicket = null;
            analyst.ticketStatus = null;
            
            if (analyst.name === "Eric" || analyst.name === "Tamiris") {
                analyst.inQueue = true;
            }
            
            updateQueueOrder();
            updateQueueDisplay();
            updateSpecialCasesDisplay();
            updateStatistics();
            
            showNotification(`Chamado ${ticketNumber} finalizado por ${analyst.name}`, 'success');
            saveFirebaseState();
        }

        // ============================================
        // FUNÇÕES DE RELATÓRIO CSV (ATUALIZADAS PARA FIREBASE)
        // ============================================
        
        function setupReportDates() {
            const today = new Date();
            const lastWeek = new Date();
            lastWeek.setDate(today.getDate() - 7);
            
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        async function generateCSVReport() {
            if (!state.user || !state.isOnline) {
                showNotification('Sem conexão com o banco de dados', 'error');
                return;
            }
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const includeAllTickets = document.getElementById('includeAllTickets').checked;
            
            if (!startDate || !endDate) {
                showNotification('Selecione as datas inicial e final', 'warning');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            if (start > end) {
                showNotification('A data inicial não pode ser maior que a data final', 'error');
                return;
            }
            
            try {
                showNotification('Buscando dados no Firebase...', 'info');
                
                const tickets = await getTicketsByDateRange(startDate, endDate, includeAllTickets);
                
                if (tickets.length === 0) {
                    showNotification('Nenhum chamado encontrado no período selecionado', 'warning');
                    return;
                }
                
                const csvContent = createCSVContent(tickets);
                downloadCSV(csvContent, startDate, endDate);
                
                closeReportModal();
                showNotification(`Relatório CSV gerado com ${tickets.length} registros`, 'success');
                
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }

        function createCSVContent(tickets) {
            let csv = 'Número do Chamado,Analista,Data de Atendimento,Status,Hora,Data Completa\n';
            
            tickets.forEach(ticket => {
                const dateObj = ticket.timestamp instanceof Date ? ticket.timestamp : new Date(ticket.timestamp);
                const dateStr = dateObj.toLocaleDateString('pt-BR');
                const timeStr = dateObj.toLocaleTimeString('pt-BR');
                const fullDate = dateObj.toISOString();
                
                const ticketNumber = `"${ticket.ticketNumber}"`;
                const analyst = `"${ticket.analyst}"`;
                const date = `"${dateStr}"`;
                const status = `"${ticket.status}"`;
                const time = `"${timeStr}"`;
                const fullDateTime = `"${fullDate}"`;
                
                csv += `${ticketNumber},${analyst},${date},${status},${time},${fullDateTime}\n`;
            });
            
            return csv;
        }

        function downloadCSV(csvContent, startDate, endDate) {
            const startFormatted = startDate.replace(/-/g, '');
            const endFormatted = endDate.replace(/-/g, '');
            const filename = `relatorio_chamados_${startFormatted}_a_${endFormatted}_${Date.now()}.csv`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // ============================================
        // FUNÇÕES AUXILIARES
        // ============================================
        
        function updateApp() {
            updateCurrentTime();
            updateLastUpdateTime();
            checkDailyReset();
        }

        function updateLastUpdateTime() {
            state.lastUpdate = new Date().toLocaleTimeString('pt-BR');
            document.getElementById('lastUpdate').textContent = state.lastUpdate;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        function saveState() {
            try {
                const stateToSave = {
                    ...state,
                    simulatedTime: state.simulatedTime ? state.simulatedTime.getTime() : null,
                    analysts: analysts.map(a => ({
                        id: a.id,
                        ticketsHandled: a.ticketsHandled,
                        isBusy: a.isBusy,
                        currentTicket: a.currentTicket,
                        ticketStatus: a.ticketStatus,
                        inQueue: a.inQueue
                    }))
                };
                
                localStorage.setItem('queuePortalState', JSON.stringify(stateToSave));
            } catch (e) {
                console.error('Erro ao salvar estado:', e);
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('queuePortalState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    
                    state.ticketsToday = parsedState.ticketsToday || 0;
                    state.specialTicketsToday = parsedState.specialTicketsToday || 0;
                    state.waitingTicketsToday = parsedState.waitingTicketsToday || 0;
                    state.lastReset = parsedState.lastReset || new Date().toLocaleDateString('pt-BR');
                    state.currentAnalystIndex = parsedState.currentAnalystIndex || 0;
                    state.nextTicketNumber = parsedState.nextTicketNumber || 1000;
                    state.dailyResetDone = parsedState.dailyResetDone || false;
                    
                    if (parsedState.simulatedTime) {
                        state.simulatedTime = new Date(parsedState.simulatedTime);
                    }
                    
                    if (parsedState.analysts) {
                        parsedState.analysts.forEach(savedAnalyst => {
                            const analyst = analysts.find(a => a.id === savedAnalyst.id);
                            if (analyst) {
                                analyst.ticketsHandled = savedAnalyst.ticketsHandled || 0;
                                analyst.isBusy = savedAnalyst.isBusy || false;
                                analyst.currentTicket = savedAnalyst.currentTicket || null;
                                analyst.ticketStatus = savedAnalyst.ticketStatus || null;
                                analyst.inQueue = savedAnalyst.inQueue !== undefined ? savedAnalyst.inQueue : true;
                            }
                        });
                    }
                    
                    updateQueueOrder();
                    updateQueueDisplay();
                    updateSpecialCasesDisplay();
                    updateStatistics();
                    
                    showNotification('Estado anterior restaurado', 'info');
                }
            } catch (e) {
                console.error('Erro ao carregar estado:', e);
            }
        }
    </script>
</body>
</html>
