<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administra√ß√£o - Portal Payhub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            padding: 30px;
        }
        
        .admin-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .admin-section h2 {
            font-size: 20px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .admin-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .admin-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-card p {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .form-group-admin {
            margin-bottom: 20px;
        }
        
        .form-group-admin label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-group-admin input,
        .form-group-admin select,
        .form-group-admin textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group-admin input:focus,
        .form-group-admin select:focus,
        .form-group-admin textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .danger-zone {
            border-color: #f44336;
            background: #FFEBEE;
        }
        
        .danger-zone h2 {
            color: #f44336;
        }
        
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-item-admin {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .info-label-admin {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .info-value-admin {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }
        
        .backup-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .log-container {
            background: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #495057;
        }
        
        .log-time {
            color: #adb5bd;
            margin-right: 10px;
        }
        
        .log-message {
            color: #f8f9fa;
        }
        
        .log-error { color: #ff6b6b; }
        .log-warning { color: #ffd93d; }
        .log-success { color: #6bcf7f; }
        .log-info { color: #4dabf7; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-cogs"></i>
                    Administra√ß√£o do Sistema
                    <span class="version-badge">v3.5.0</span>
                </h1>
                <p>Configura√ß√µes avan√ßadas e manuten√ß√£o</p>
            </div>
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                Voltar ao Painel
            </a>
        </div>
        
        <div class="nav-menu">
            <a href="index.html" class="nav-link">
                <i class="fas fa-home"></i>
                Painel Principal
            </a>
            <a href="analyst-view.html" class="nav-link">
                <i class="fas fa-eye"></i>
                Visualiza√ß√£o
            </a>
            <a href="admin.html" class="nav-link active">
                <i class="fas fa-cogs"></i>
                Administra√ß√£o
            </a>
        </div>
        
        <div class="admin-container">
            <!-- Se√ß√£o: Informa√ß√µes do Sistema -->
            <div class="admin-section">
                <h2><i class="fas fa-info-circle"></i> Informa√ß√µes do Sistema</h2>
                <div class="system-info">
                    <div class="info-item-admin">
                        <div class="info-label-admin">Vers√£o do Sistema</div>
                        <div class="info-value-admin" id="systemVersion">v3.5.0</div>
                    </div>
                    <div class="info-item-admin">
                        <div class="info-label-admin">Status Firebase</div>
                        <div class="info-value-admin" id="firebaseAdminStatus">Verificando...</div>
                    </div>
                    <div class="info-item-admin">
                        <div class="info-label-admin">√öltimo Backup</div>
                        <div class="info-value-admin" id="lastBackupTime">Nunca</div>
                    </div>
                    <div class="info-item-admin">
                        <div class="info-label-admin">Sess√£o Atual</div>
                        <div class="info-value-admin" id="currentSession">---</div>
                    </div>
                </div>
            </div>
            
            <!-- Se√ß√£o: Backup e Restaura√ß√£o -->
            <div class="admin-section">
                <h2><i class="fas fa-database"></i> Backup e Restaura√ß√£o</h2>
                <div class="admin-grid">
                    <div class="admin-card">
                        <h3><i class="fas fa-save"></i> Backup Manual</h3>
                        <p>Crie um backup completo do estado atual do sistema.</p>
                        <button class="btn btn-success" onclick="createBackup()">
                            <i class="fas fa-save"></i> Criar Backup
                        </button>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-undo"></i> Restaurar Backup</h3>
                        <p>Restaurar o sistema a partir de um backup anterior.</p>
                        <input type="file" id="backupFile" accept=".json" style="margin-bottom: 15px;">
                        <button class="btn btn-warning" onclick="restoreBackup()">
                            <i class="fas fa-undo"></i> Restaurar
                        </button>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-download"></i> Exportar Dados</h3>
                        <p>Exporte todos os dados para arquivo JSON.</p>
                        <button class="btn" onclick="exportData()">
                            <i class="fas fa-download"></i> Exportar JSON
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Se√ß√£o: Manuten√ß√£o -->
            <div class="admin-section">
                <h2><i class="fas fa-tools"></i> Manuten√ß√£o do Sistema</h2>
                <div class="backup-controls">
                    <button class="btn" onclick="clearLocalStorage()">
                        <i class="fas fa-trash"></i> Limpar Cache Local
                    </button>
                    <button class="btn" onclick="reloadFirebase()">
                        <i class="fas fa-sync"></i> Recarregar Firebase
                    </button>
                    <button class="btn btn-warning" onclick="forceResetQueue()">
                        <i class="fas fa-redo"></i> For√ßar Reset da Fila
                    </button>
                </div>
            </div>
            
            <!-- Se√ß√£o: Logs do Sistema -->
            <div class="admin-section">
                <h2><i class="fas fa-clipboard-list"></i> Logs do Sistema</h2>
                <div class="log-container" id="systemLogs">
                    <div class="log-entry">
                        <span class="log-time">[00:00:00]</span>
                        <span class="log-message">Sistema inicializado...</span>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-small" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> Limpar Logs
                    </button>
                    <button class="btn btn-small" onclick="exportLogs()">
                        <i class="fas fa-download"></i> Exportar Logs
                    </button>
                </div>
            </div>
            
            <!-- Se√ß√£o: Zona de Perigo -->
            <div class="admin-section danger-zone">
                <h2><i class="fas fa-exclamation-triangle"></i> Zona de Perigo</h2>
                <p style="color: #f44336; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Aten√ß√£o:</strong> Estas opera√ß√µes s√£o irrevers√≠veis e podem afetar o funcionamento do sistema.
                </p>
                <div class="backup-controls">
                    <button class="btn btn-danger" onclick="resetEverything()">
                        <i class="fas fa-bomb"></i> Resetar Tudo
                    </button>
                    <button class="btn btn-danger" onclick="deleteFirebaseData()">
                        <i class="fas fa-fire"></i> Limpar Firebase
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>Portal de Fila de Chamados - Administra√ß√£o</strong> | v3.5.0</p>
            <p>Use com cautela. A√ß√µes administrativas s√£o registradas.</p>
        </div>
    </div>
    
    <script src="firebase-config.js"></script>
    <script src="firebase-app.js"></script>
    <script>
        // Logs do sistema
        const systemLogs = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemInfo();
            updateLogDisplay();
            
            // Log inicial
            addLog('Sistema de administra√ß√£o carregado', 'info');
        });
        
        function loadSystemInfo() {
            // Vers√£o
            document.getElementById('systemVersion').textContent = 'v3.5.0';
            
            // Sess√£o
            const sessionId = sessionStorage.getItem('queue_session_id') || 'N√£o definida';
            document.getElementById('currentSession').textContent = sessionId.substring(0, 12) + '...';
            
            // Status Firebase
            const firebaseStatus = window.firebaseAppIntegration ? 
                (window.firebaseAppIntegration.initialized ? '‚úÖ Conectado' : '‚ùå Offline') : 
                'N√£o carregado';
            document.getElementById('firebaseAdminStatus').textContent = firebaseStatus;
            
            // √öltimo backup
            const lastBackup = localStorage.getItem('last_backup_time');
            document.getElementById('lastBackupTime').textContent = lastBackup || 'Nunca';
        }
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            systemLogs.push({ timestamp, message, type });
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const container = document.getElementById('systemLogs');
            if (!container) return;
            
            let html = '';
            systemLogs.slice(-50).forEach(log => {
                html += `
                    <div class="log-entry">
                        <span class="log-time">[${log.timestamp}]</span>
                        <span class="log-message log-${log.type}">${log.message}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        // Fun√ß√µes de backup
        function createBackup() {
            try {
                const state = JSON.parse(localStorage.getItem('queue_state') || '{}');
                const backupData = {
                    ...state,
                    backupTime: new Date().toISOString(),
                    backupType: 'manual'
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `backup_payhub_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                
                localStorage.setItem('last_backup_time', new Date().toLocaleString('pt-BR'));
                loadSystemInfo();
                
                addLog('Backup criado com sucesso', 'success');
                alert('‚úÖ Backup criado com sucesso!');
                
            } catch (error) {
                addLog(`Erro ao criar backup: ${error.message}`, 'error');
                alert('‚ùå Erro ao criar backup');
            }
        }
        
        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Selecione um arquivo de backup');
                return;
            }
            
            if (!confirm('ATEN√á√ÉO: Esta a√ß√£o substituir√° todos os dados atuais. Continuar?')) {
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validar backup
                    if (!backupData.backupTime || !backupData.version) {
                        throw new Error('Arquivo de backup inv√°lido');
                    }
                    
                    // Restaurar dados
                    localStorage.setItem('queue_state', JSON.stringify(backupData));
                    
                    addLog(`Backup restaurado: ${backupData.backupTime}`, 'success');
                    alert('‚úÖ Backup restaurado com sucesso! Recarregue a p√°gina.');
                    
                } catch (error) {
                    addLog(`Erro ao restaurar backup: ${error.message}`, 'error');
                    alert('‚ùå Erro ao restaurar backup');
                }
            };
            
            reader.readAsText(file);
        }
        
        function exportData() {
            try {
                const state = JSON.parse(localStorage.getItem('queue_state') || '{}');
                const exportData = {
                    ...state,
                    exportTime: new Date().toISOString(),
                    exportType: 'full_export'
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `dados_payhub_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                
                addLog('Dados exportados com sucesso', 'success');
                
            } catch (error) {
                addLog(`Erro ao exportar dados: ${error.message}`, 'error');
            }
        }
        
        // Fun√ß√µes de manuten√ß√£o
        function clearLocalStorage() {
            if (!confirm('Limpar todo o cache local?\nIsso remover√° dados n√£o sincronizados.')) {
                return;
            }
            
            try {
                localStorage.clear();
                sessionStorage.clear();
                
                addLog('Cache local limpo', 'warning');
                alert('‚úÖ Cache limpo com sucesso!');
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                addLog(`Erro ao limpar cache: ${error.message}`, 'error');
            }
        }
        
        function reloadFirebase() {
            if (window.firebaseAppIntegration) {
                window.firebaseAppIntegration.init();
                addLog('Firebase recarregado', 'info');
                alert('Firebase sendo recarregado...');
            }
        }
        
        function forceResetQueue() {
            if (!confirm('For√ßar reset da fila?\nTodos os dados atuais ser√£o perdidos.')) {
                return;
            }
            
            const resetState = {
                appState: {
                    ticketsToday: 0,
                    specialTicketsToday: 0,
                    waitingTicketsToday: 0,
                    lastReset: new Date().toLocaleDateString('pt-BR'),
                    nextTicketNumber: 1000
                },
                analysts: window.analysts.map(a => ({
                    id: a.id,
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketStatus: null,
                    ticketSpecialType: null,
                    ticketsHandled: 0,
                    isWaitingForClient: false,
                    inQueue: a.level === "N1",
                    lastActivity: null
                })),
                queueOrder: [],
                version: '3.5.0',
                resetTime: new Date().toISOString()
            };
            
            localStorage.setItem('queue_state', JSON.stringify(resetState));
            
            addLog('Fila resetada for√ßadamente', 'warning');
            alert('‚úÖ Fila resetada! Recarregue a p√°gina.');
        }
        
        // Fun√ß√µes de logs
        function clearLogs() {
            systemLogs.length = 0;
            updateLogDisplay();
            addLog('Logs limpos', 'info');
        }
        
        function exportLogs() {
            const logText = systemLogs.map(log => 
                `[${log.timestamp}] ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `logs_payhub_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            addLog('Logs exportados', 'info');
        }
        
        // Fun√ß√µes perigosas
        function resetEverything() {
            if (!confirm('üö® RESETAR TUDO?\n\nEsta a√ß√£o √© IRREVERS√çVEL e ir√°:\n‚Ä¢ Apagar todos os dados locais\n‚Ä¢ Limpar todo o hist√≥rico\n‚Ä¢ Resetar o sistema para o estado inicial\n\nDigite "RESETAR" para confirmar:')) {
                return;
            }
            
            const confirmation = prompt('Digite "RESETAR" para confirmar:');
            if (confirmation !== 'RESETAR') {
                addLog('Reset cancelado pelo usu√°rio', 'warning');
                return;
            }
            
            // Limpar tudo
            localStorage.clear();
            sessionStorage.clear();
            
            addLog('Sistema completamente resetado', 'error');
            alert('‚úÖ Sistema resetado! Reiniciando...');
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
        
        function deleteFirebaseData() {
            if (!confirm('üö® LIMPAR DADOS DO FIREBASE?\n\nEsta a√ß√£o tentar√° apagar todos os dados no Firebase.\nIsso pode n√£o ser revers√≠vel.\n\nDigite "APAGAR" para confirmar:')) {
                return;
            }
            
            const confirmation = prompt('Digite "APAGAR" para confirmar:');
            if (confirmation !== 'APAGAR') {
                addLog('Exclus√£o Firebase cancelada', 'warning');
                return;
            }
            
            addLog('Tentando limpar dados Firebase...', 'warning');
            alert('‚ö†Ô∏è Esta funcionalidade requer implementa√ß√£o espec√≠fica no servidor.');
            
            // Nota: A exclus√£o completa no Firebase geralmente requer regras de seguran√ßa
            // ou fun√ß√µes do Cloud Functions. Aqui apenas mostramos uma mensagem.
        }
    </script>
</body>
</html>
