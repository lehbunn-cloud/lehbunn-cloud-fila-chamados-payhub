<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Firebase - Portal Payhub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #5a67d8;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-success {
            background: #2ecc71;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background: #f2f2f2;
        }
        .status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-iniciado { background: #3498db; color: white; }
        .status-aguardando { background: #f39c12; color: white; }
        .status-finalizado { background: #2ecc71; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-database"></i> Consulta Firebase - Portal Payhub</h1>
        
        <div class="section">
            <h2><i class="fas fa-plug"></i> Status da Conex√£o</h2>
            <div id="connectionStatus">Verificando...</div>
            <button class="btn" onclick="testConnection()">
                <i class="fas fa-vial"></i> Testar Conex√£o
            </button>
        </div>
        
        <div class="section">
            <h2><i class="fas fa-history"></i> Consultar Tickets por Per√≠odo</h2>
            <div>
                <label>Data Inicial: <input type="date" id="queryStartDate"></label>
                <label>Data Final: <input type="date" id="queryEndDate"></label>
                <button class="btn btn-success" onclick="queryTickets()">
                    <i class="fas fa-search"></i> Consultar Tickets
                </button>
                <button class="btn" onclick="getAllTickets()">
                    <i class="fas fa-list"></i> Todos os Tickets
                </button>
            </div>
            <div id="ticketsResult" class="result"></div>
        </div>
        
        <div class="section">
            <h2><i class="fas fa-sync"></i> Estados da Fila</h2>
            <button class="btn" onclick="getQueueStates()">
                <i class="fas fa-database"></i> Buscar Estados Salvos
            </button>
            <button class="btn" onclick="getCurrentState()">
                <i class="fas fa-eye"></i> Ver Estado Atual
            </button>
            <div id="statesResult" class="result"></div>
        </div>
        
        <div class="section">
            <h2><i class="fas fa-cogs"></i> Manuten√ß√£o</h2>
            <button class="btn btn-danger" onclick="clearAllData()">
                <i class="fas fa-trash"></i> Limpar Todos os Dados (CUIDADO!)
            </button>
            <button class="btn" onclick="syncOfflineTickets()">
                <i class="fas fa-cloud-upload-alt"></i> Sincronizar Tickets Offline
            </button>
        </div>
        
        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> Estat√≠sticas</h2>
            <button class="btn" onclick="getStats()">
                <i class="fas fa-chart-pie"></i> Gerar Estat√≠sticas
            </button>
            <div id="statsResult" class="result"></div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Configura√ß√£o -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCJXxaG8R5-VmkoGA7PyFcyfcvBAk92yTc",
            authDomain: "portal-fila-payhub.firebaseapp.com",
            projectId: "portal-fila-payhub",
            storageBucket: "portal-fila-payhub.firebasestorage.app",
            messagingSenderId: "28871537008",
            appId: "1:28871537008:web:38d6ac22721f40a7d61fb5"
        };
        
        // Inicializar Firebase
        let db;
        try {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(app);
            document.getElementById('connectionStatus').innerHTML = 
                '<span style="color: green;"><i class="fas fa-check-circle"></i> Conectado ao Firebase</span>';
            console.log('‚úÖ Firebase inicializado para consultas');
        } catch (error) {
            document.getElementById('connectionStatus').innerHTML = 
                '<span style="color: red;"><i class="fas fa-times-circle"></i> Erro: ' + error.message + '</span>';
            console.error('‚ùå Erro ao inicializar Firebase:', error);
        }
        
        async function testConnection() {
            try {
                const testDoc = db.collection('_tests').doc('connection_test');
                await testDoc.set({
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'Teste de conex√£o bem-sucedido'
                });
                alert('‚úÖ Conex√£o com Firebase funcionando!');
            } catch (error) {
                alert('‚ùå Erro na conex√£o: ' + error.message);
            }
        }
        
        async function queryTickets() {
            const startDate = document.getElementById('queryStartDate').value;
            const endDate = document.getElementById('queryEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Selecione ambas as datas');
                return;
            }
            
            try {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                const snapshot = await db.collection('tickets')
                    .where('createdAt', '>=', start.toISOString())
                    .where('createdAt', '<=', end.toISOString())
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (snapshot.empty) {
                    document.getElementById('ticketsResult').innerHTML = 'Nenhum ticket encontrado para este per√≠odo.';
                    return;
                }
                
                let html = `<h3>${snapshot.size} tickets encontrados:</h3>`;
                html += '<table>';
                html += '<tr><th>Ticket</th><th>Analista</th><th>Status</th><th>Tipo</th><th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o</th></tr>';
                
                snapshot.forEach(doc => {
                    const ticket = doc.data();
                    html += `
                        <tr>
                            <td><strong>${ticket.ticketNumber || 'N/A'}</strong></td>
                            <td>${ticket.analystName || 'N/A'}</td>
                            <td><span class="status status-${ticket.status || 'desconhecido'}">${ticket.status || 'N/A'}</span></td>
                            <td>${ticket.clientType || 'normal'}</td>
                            <td>${formatDate(ticket.startTime)}</td>
                            <td>${formatDate(ticket.endTime)}</td>
                            <td>${ticket.duration ? ticket.duration + 's' : '-'}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('ticketsResult').innerHTML = html;
                
            } catch (error) {
                document.getElementById('ticketsResult').innerHTML = 
                    '‚ùå Erro na consulta: ' + error.message;
                console.error(error);
            }
        }
        
        async function getAllTickets() {
            try {
                const snapshot = await db.collection('tickets')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                
                if (snapshot.empty) {
                    document.getElementById('ticketsResult').innerHTML = 'Nenhum ticket encontrado no banco.';
                    return;
                }
                
                let html = `<h3>√öltimos ${snapshot.size} tickets:</h3>`;
                html += '<table>';
                html += '<tr><th>Ticket</th><th>Analista</th><th>Status</th><th>Tipo</th><th>In√≠cio</th></tr>';
                
                snapshot.forEach(doc => {
                    const ticket = doc.data();
                    html += `
                        <tr>
                            <td><strong>${ticket.ticketNumber || 'N/A'}</strong></td>
                            <td>${ticket.analystName || 'N/A'}</td>
                            <td><span class="status status-${ticket.status || 'desconhecido'}">${ticket.status || 'N/A'}</span></td>
                            <td>${ticket.clientType || 'normal'}</td>
                            <td>${formatDate(ticket.createdAt)}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('ticketsResult').innerHTML = html;
                
            } catch (error) {
                document.getElementById('ticketsResult').innerHTML = 
                    '‚ùå Erro na consulta: ' + error.message;
                console.error(error);
            }
        }
        
        async function getQueueStates() {
            try {
                const snapshot = await db.collection('queue_states')
                    .orderBy('savedAt', 'desc')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    document.getElementById('statesResult').innerHTML = 'Nenhum estado salvo encontrado.';
                    return;
                }
                
                let html = `<h3>√öltimos ${snapshot.size} estados:</h3>`;
                
                snapshot.forEach(doc => {
                    const state = doc.data();
                    const activeTickets = state.analysts ? 
                        state.analysts.filter(a => a.currentTicket).length : 0;
                    
                    html += `
                        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>Sess√£o:</strong> ${state.sessionId?.substring(0, 20)}...<br>
                            <strong>Salvo em:</strong> ${formatDate(state.savedAt)}<br>
                            <strong>Vers√£o:</strong> ${state.version || 'N/A'}<br>
                            <strong>Analistas:</strong> ${state.analysts?.length || 0}<br>
                            <strong>Tickets ativos:</strong> ${activeTickets}<br>
                            <strong>Chamados hoje:</strong> ${state.appState?.ticketsToday || 0}<br>
                            <button class="btn" onclick="viewStateDetails('${doc.id}')" style="margin-top: 5px;">
                                Ver Detalhes
                            </button>
                        </div>
                    `;
                });
                
                document.getElementById('statesResult').innerHTML = html;
                
            } catch (error) {
                document.getElementById('statesResult').innerHTML = 
                    '‚ùå Erro na consulta: ' + error.message;
                console.error(error);
            }
        }
        
        async function viewStateDetails(stateId) {
            try {
                const doc = await db.collection('queue_states').doc(stateId).get();
                if (!doc.exists) {
                    alert('Estado n√£o encontrado');
                    return;
                }
                
                const state = doc.data();
                let html = '<h4>Detalhes do Estado:</h4>';
                html += '<pre>' + JSON.stringify(state, null, 2) + '</pre>';
                
                // Tickets ativos
                if (state.analysts) {
                    const activeAnalysts = state.analysts.filter(a => a.currentTicket);
                    if (activeAnalysts.length > 0) {
                        html += '<h4>Tickets Ativos neste Estado:</h4>';
                        html += '<ul>';
                        activeAnalysts.forEach(a => {
                            html += `<li>${a.name}: ${a.currentTicket} (${a.ticketStatus || 'N/A'})</li>`;
                        });
                        html += '</ul>';
                    }
                }
                
                document.getElementById('statesResult').innerHTML = html;
                
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        async function getCurrentState() {
            try {
                // Buscar estado mais recente
                const snapshot = await db.collection('queue_states')
                    .orderBy('savedAt', 'desc')
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    document.getElementById('statesResult').innerHTML = 'Nenhum estado encontrado.';
                    return;
                }
                
                const doc = snapshot.docs[0];
                const state = doc.data();
                
                let html = '<h4>Estado Mais Recente:</h4>';
                html += `<strong>Salvo em:</strong> ${formatDate(state.savedAt)}<br>`;
                html += `<strong>Sess√£o:</strong> ${state.sessionId?.substring(0, 30)}...<br>`;
                
                // Analistas com tickets
                if (state.analysts) {
                    html += '<h4>Analistas:</h4>';
                    state.analysts.forEach(a => {
                        html += `<div style="margin: 5px 0; padding: 5px; background: ${a.currentTicket ? '#ffeaa7' : '#f1f2f6'}; border-radius: 3px;">`;
                        html += `<strong>${a.name}</strong> - ${a.currentTicket ? `Ticket: ${a.currentTicket} (${a.ticketStatus})` : 'Sem ticket'}`;
                        html += '</div>';
                    });
                }
                
                document.getElementById('statesResult').innerHTML = html;
                
            } catch (error) {
                document.getElementById('statesResult').innerHTML = 
                    '‚ùå Erro: ' + error.message;
            }
        }
        
        async function getStats() {
            try {
                // Total de tickets
                const ticketsSnapshot = await db.collection('tickets').get();
                const totalTickets = ticketsSnapshot.size;
                
                // Tickets por status
                const iniciado = await db.collection('tickets').where('status', '==', 'iniciado').get();
                const aguardando = await db.collection('tickets').where('status', '==', 'aguardando').get();
                const finalizado = await db.collection('tickets').where('status', '==', 'finalizado').get();
                
                // √öltimos 7 dias
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const recentSnapshot = await db.collection('tickets')
                    .where('createdAt', '>=', weekAgo.toISOString())
                    .get();
                
                let html = '<h3>Estat√≠sticas do Sistema:</h3>';
                html += `<strong>Total de tickets:</strong> ${totalTickets}<br>`;
                html += `<strong>Status dos tickets:</strong><br>`;
                html += `  ‚Ä¢ Iniciado: ${iniciado.size}<br>`;
                html += `  ‚Ä¢ Aguardando: ${aguardando.size}<br>`;
                html += `  ‚Ä¢ Finalizado: ${finalizado.size}<br>`;
                html += `<strong>Tickets nos √∫ltimos 7 dias:</strong> ${recentSnapshot.size}<br>`;
                
                document.getElementById('statsResult').innerHTML = html;
                
            } catch (error) {
                document.getElementById('statsResult').innerHTML = 
                    '‚ùå Erro: ' + error.message;
            }
        }
        
        async function clearAllData() {
            if (!confirm('üö® ATEN√á√ÉO: Isso apagar√° TODOS os dados do Firebase. Continuar?')) {
                return;
            }
            
            try {
                // Apagar tickets
                const ticketsSnapshot = await db.collection('tickets').get();
                const ticketBatch = db.batch();
                ticketsSnapshot.forEach(doc => {
                    ticketBatch.delete(doc.ref);
                });
                await ticketBatch.commit();
                
                // Apagar estados
                const statesSnapshot = await db.collection('queue_states').get();
                const stateBatch = db.batch();
                statesSnapshot.forEach(doc => {
                    stateBatch.delete(doc.ref);
                });
                await stateBatch.commit();
                
                alert(`‚úÖ Dados apagados: ${ticketsSnapshot.size} tickets e ${statesSnapshot.size} estados`);
                
            } catch (error) {
                alert('‚ùå Erro: ' + error.message);
            }
        }
        
        async function syncOfflineTickets() {
            try {
                const offlineTickets = JSON.parse(localStorage.getItem('offline_tickets') || '[]');
                const pending = offlineTickets.filter(t => !t.synced);
                
                if (pending.length === 0) {
                    alert('Nenhum ticket offline para sincronizar');
                    return;
                }
                
                alert(`Sincronizando ${pending.length} tickets offline...`);
                
                for (const ticket of pending) {
                    try {
                        await db.collection('tickets').add({
                            ticketNumber: ticket.ticketNumber,
                            analystName: ticket.analystName,
                            status: ticket.status,
                            clientType: ticket.clientType,
                            startTime: ticket.timestamp,
                            createdAt: ticket.timestamp,
                            updatedAt: new Date().toISOString(),
                            synced: true,
                            source: 'offline_sync'
                        });
                        
                        ticket.synced = true;
                    } catch (error) {
                        console.error('Erro ao sincronizar ticket:', error);
                    }
                }
                
                localStorage.setItem('offline_tickets', JSON.stringify(offlineTickets));
                alert(`‚úÖ ${pending.length} tickets sincronizados!`);
                
            } catch (error) {
                alert('Erro na sincroniza√ß√£o: ' + error.message);
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR');
            } catch (error) {
                return dateString;
            }
        }
        
        // Configurar datas padr√£o
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            document.getElementById('queryStartDate').value = weekAgo.toISOString().split('T')[0];
            document.getElementById('queryEndDate').value = today;
            
            // Testar conex√£o automaticamente
            testConnection();
        };
    </script>
</body>
</html>