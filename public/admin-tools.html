<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramentas Admin - Portal Payhub</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="style.css">
    
    <style>
        .admin-tools-container {
            padding: 30px;
        }
        
        .admin-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .admin-section h2 {
            font-size: 20px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .admin-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .admin-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-card p {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .form-group-admin {
            margin-bottom: 20px;
        }
        
        .form-group-admin label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-group-admin input,
        .form-group-admin select,
        .form-group-admin textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group-admin input:focus,
        .form-group-admin select:focus,
        .form-group-admin textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .danger-zone {
            border-color: #f44336;
            background: #FFEBEE;
        }
        
        .danger-zone h2 {
            color: #f44336;
        }
        
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-item-admin {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .info-label-admin {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .info-value-admin {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }
        
        .backup-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .log-container {
            background: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #495057;
        }
        
        .log-time {
            color: #adb5bd;
            margin-right: 10px;
        }
        
        .log-message {
            color: #f8f9fa;
        }
        
        .log-error { color: #ff6b6b; }
        .log-warning { color: #ffd93d; }
        .log-success { color: #6bcf7f; }
        .log-info { color: #4dabf7; }
        
        .auth-warning {
            background: #FFF3E0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #FF9800;
        }
    </style>
</head>
<body>
    <!-- Overlay de autentica√ß√£o -->
    <div id="authOverlay" class="modal-overlay" style="display: flex;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-lock"></i>
                    Verifica√ß√£o de Acesso
                </div>
            </div>
            <div class="modal-body" style="text-align: center; padding: 40px 20px;">
                <div class="loading-spinner-large" style="margin-bottom: 20px;"></div>
                <h3 style="margin-bottom: 10px;">Verificando autentica√ß√£o...</</h3>
                <p style="color: #6c757d;">Aguarde enquanto verificamos suas credenciais.</p>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-tools"></i>
                    Ferramentas Administrativas
                    <span class="version-badge">v4.0.0</span>
                </h1>
                <p>Configura√ß√µes avan√ßadas e manuten√ß√£o do sistema</p>
            </div>
            <a href="admin-dashboard.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                Voltar ao Dashboard
            </a>
        </div>
        
        <div class="nav-menu">
            <a href="admin-dashboard.html" class="nav-link">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            <a href="analyst-view.html" target="_blank" class="nav-link">
                <i class="fas fa-eye"></i>
                Visualiza√ß√£o P√∫blica
            </a>
            <a href="admin-tools.html" class="nav-link active">
                <i class="fas fa-tools"></i>
                Ferramentas Admin
            </a>
        </div>
        
        <div class="admin-tools-container">
            <!-- Aviso de autentica√ß√£o -->
            <div class="auth-warning">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <i class="fas fa-shield-alt" style="color: #FF9800; font-size: 20px;"></i>
                    <strong>√Årea Restrita</strong>
                </div>
                <p style="margin: 0; color: #5a3c00;">Esta √°rea cont√©m fun√ß√µes cr√≠ticas do sistema. Use com responsabilidade.</p>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #8a6d3b;">
                    <i class="fas fa-user-shield"></i> Logado como: <strong id="currentAdminUser">Administrador</strong>
                </p>
            </div>
            
            <!-- Se√ß√£o: Informa√ß√µes do Sistema -->
            <div class="admin-section">
                <h2><i class="fas fa-info-circle"></i> Informa√ß√µes do Sistema</h2>
                <div class="system-info">
                    <div class="info-item-admin">
                        <div class="info-label-admin">Vers√£o do Sistema</div>
                        <div class="info-value-admin" id="systemVersion">v4.0.0</div>
                    </div>
                    <div class="info-item-admin">
                        <div class="info-label-admin">Status Firebase</div>
                        <div class="info-value-admin" id="firebaseAdminStatus">Verificando...</div>
                    </div>
                    <div class="info-item-admin">
                        <div class="info-label-admin">√öltimo Backup</div>
                        <div class="info-value-admin" id="lastBackupTime">Nunca</div>
                    </div>
                    <div class="info-item-admin">
                        <div class="info-label-admin">Analistas Cadastrados</div>
                        <div class="info-value-admin" id="totalAnalystsCount">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Se√ß√£o: Gerenciar Analistas -->
            <div class="admin-section">
                <h2><i class="fas fa-users-cog"></i> Gerenciar Analistas</h2>
                <div class="admin-grid">
                    <div class="admin-card">
                        <h3><i class="fas fa-user-plus"></i> Cadastrar Analistas</h3>
                        <p>Cadastrar todos os analistas no Firebase com hor√°rios e clientes especiais</p>
                        <button class="btn btn-success" onclick="setupAnalystsInFirebase()">
                            <i class="fas fa-save"></i> Cadastrar no Firebase
                        </button>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-sync-alt"></i> Sincronizar Dados</h3>
                        <p>Sincronizar dados locais com o Firebase</p>
                        <button class="btn" onclick="syncWithFirebase()">
                            <i class="fas fa-sync"></i> Sincronizar Agora
                        </button>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-list"></i> Listar Analistas</h3>
                        <p>Visualizar todos os analistas cadastrados</p>
                        <button class="btn" onclick="listAnalysts()">
                            <i class="fas fa-list"></i> Ver Lista
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Se√ß√£o: Backup e Restaura√ß√£o -->
            <div class="admin-section">
                <h2><i class="fas fa-database"></i> Backup e Restaura√ß√£o</h2>
                <div class="admin-grid">
                    <div class="admin-card">
                        <h3><i class="fas fa-save"></i> Backup Manual</h3>
                        <p>Crie um backup completo do estado atual do sistema.</p>
                        <button class="btn btn-success" onclick="createBackup()">
                            <i class="fas fa-save"></i> Criar Backup
                        </button>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-undo"></i> Restaurar Backup</h3>
                        <p>Restaurar o sistema a partir de um backup anterior.</p>
                        <input type="file" id="backupFile" accept=".json" style="margin-bottom: 15px;">
                        <button class="btn btn-warning" onclick="restoreBackup()">
                            <i class="fas fa-undo"></i> Restaurar
                        </button>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-download"></i> Exportar Dados</h3>
                        <p>Exporte todos os dados para arquivo JSON.</p>
                        <button class="btn" onclick="exportData()">
                            <i class="fas fa-download"></i> Exportar JSON
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Se√ß√£o: Manuten√ß√£o -->
            <div class="admin-section">
                <h2><i class="fas fa-tools"></i> Manuten√ß√£o do Sistema</h2>
                <div class="backup-controls">
                    <button class="btn" onclick="clearLocalStorage()">
                        <i class="fas fa-trash"></i> Limpar Cache Local
                    </button>
                    <button class="btn" onclick="reloadFirebase()">
                        <i class="fas fa-sync"></i> Recarregar Firebase
                    </button>
                    <button class="btn btn-warning" onclick="resetQueueOrder()">
                        <i class="fas fa-redo"></i> Resetar Ordem da Fila
                    </button>
                    <button class="btn" onclick="generateReport()">
                        <i class="fas fa-file-csv"></i> Gerar Relat√≥rio CSV
                    </button>
                </div>
            </div>
            
            <!-- Se√ß√£o: Logs do Sistema -->
            <div class="admin-section">
                <h2><i class="fas fa-clipboard-list"></i> Logs do Sistema</h2>
                <div class="log-container" id="systemLogs">
                    <div class="log-entry">
                        <span class="log-time">[00:00:00]</span>
                        <span class="log-message">Sistema inicializado...</span>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-small" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> Limpar Logs
                    </button>
                    <button class="btn btn-small" onclick="exportLogs()">
                        <i class="fas fa-download"></i> Exportar Logs
                    </button>
                </div>
            </div>
            
            <!-- Se√ß√£o: Zona de Perigo -->
            <div class="admin-section danger-zone">
                <h2><i class="fas fa-exclamation-triangle"></i> Zona de Perigo</h2>
                <p style="color: #f44336; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Aten√ß√£o:</strong> Estas opera√ß√µes s√£o irrevers√≠veis e podem afetar o funcionamento do sistema.
                </p>
                <div class="backup-controls">
                    <button class="btn btn-danger" onclick="resetEverything()">
                        <i class="fas fa-bomb"></i> Resetar Tudo
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllData()">
                        <i class="fas fa-fire"></i> Limpar Todos os Dados
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>Portal Payhub - Ferramentas Administrativas</strong> | v4.0.0</p>
            <p>Use com cautela. A√ß√µes administrativas s√£o registradas.</p>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Scripts -->
    <script src="firebase-config.js"></script>
    <script src="firebase-app.js"></script>
    <script src="app.js"></script>
    
    <script>
        // VERIFICA√á√ÉO DE AUTENTICA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== ADMIN TOOLS INICIALIZANDO ===');
            
            const authOverlay = document.getElementById('authOverlay');
            
            function checkAuth() {
                console.log('üîç Verificando autentica√ß√£o para tools...');
                
                const localAuth = localStorage.getItem('admin_auth') === 'true';
                const sessionAuth = sessionStorage.getItem('admin_auth') === 'true';
                
                if (!localAuth && !sessionAuth) {
                    console.log('‚ùå N√£o autenticado, redirecionando...');
                    window.location.href = 'login.html';
                    return false;
                }
                
                console.log('‚úÖ Autenticado para tools');
                return true;
            }
            
            if (!checkAuth()) {
                return;
            }
            
            console.log('‚úÖ Tools autenticado, carregando...');
            
            // Carregar nome do admin
            const adminUsername = localStorage.getItem('admin_user') || 'Administrador';
            document.getElementById('currentAdminUser').textContent = adminUsername;
            
            // Esconder overlay e continuar
            setTimeout(() => {
                authOverlay.style.display = 'none';
                loadSystemInfo();
                updateLogDisplay();
                addLog('Ferramentas administrativas carregadas', 'info');
            }, 300);
        });
        
        // ============================================
        // FUN√á√ïES DE GEST√ÉO DE ANALISTAS
        // ============================================
        
        async function setupAnalystsInFirebase() {
            if (!window.firebaseAppIntegration || !window.firebaseAppIntegration.initialized) {
                alert('Firebase n√£o est√° dispon√≠vel');
                return;
            }
            
            const analysts = [
                {
                    id: 1,
                    name: "Eric",
                    level: "N1",
                    startTime: 8,
                    endTime: 17,
                    specialClient: "TIM",
                    isActive: true,
                    shift: "manh√£",
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketsHandled: 0,
                    inQueue: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    name: "Carolina",
                    level: "N1",
                    startTime: 9,
                    endTime: 18,
                    specialClient: null,
                    isActive: true,
                    shift: "manh√£",
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketsHandled: 0,
                    inQueue: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 3,
                    name: "Tamiris",
                    level: "N1",
                    startTime: 9,
                    endTime: 18,
                    specialClient: null,
                    isActive: true,
                    shift: "manh√£",
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketsHandled: 0,
                    inQueue: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 4,
                    name: "Cristiane",
                    level: "N1",
                    startTime: 9,
                    endTime: 18,
                    specialClient: null,
                    isActive: true,
                    shift: "manh√£",
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketsHandled: 0,
                    inQueue: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 5,
                    name: "Jonathan",
                    level: "N1",
                    startTime: 8,
                    endTime: 17,
                    specialClient: null,
                    isActive: true,
                    shift: "manh√£",
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketsHandled: 0,
                    inQueue: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 6,
                    name: "Sander",
                    level: "N1",
                    startTime: 14,
                    endTime: 23,
                    specialClient: null,
                    isActive: true,
                    shift: "tarde",
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketsHandled: 0,
                    inQueue: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 7,
                    name: "Yan",
                    level: "N1",
                    startTime: 14,
                    endTime: 23,
                    specialClient: null,
                    isActive: true,
                    shift: "tarde",
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketsHandled: 0,
                    inQueue: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 8,
                    name: "Andr√©",
                    level: "N1",
                    startTime: 8,
                    endTime: 18,
                    specialClient: "Benoit",
                    isActive: true,
                    shift: "integral",
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketsHandled: 0,
                    inQueue: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 9,
                    name: "Felipe",
                    level: "N1",
                    startTime: 8,
                    endTime: 18,
                    specialClient: "DPSP",
                    isActive: true,
                    shift: "integral",
                    isAvailable: false,
                    isBusy: false,
                    currentTicket: null,
                    ticketsHandled: 0,
                    inQueue: true,
                    createdAt: new Date().toISOString()
                }
            ];
            
            try {
                const db = window.firebaseAppIntegration.db;
                
                // Salvar cada analista
                for (const analyst of analysts) {
                    await db.collection('analysts').doc(`analyst_${analyst.id}`).set(analyst);
                    console.log(`‚úÖ Analista ${analyst.name} cadastrado`);
                }
                
                addLog(`${analysts.length} analistas cadastrados no Firebase`, 'success');
                alert(`‚úÖ ${analysts.length} analistas cadastrados com sucesso no Firebase!`);
                
                // Atualizar contador
                document.getElementById('totalAnalystsCount').textContent = analysts.length;
                
                // Recarregar sistema
                if (window.portal) {
                    window.location.reload();
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao cadastrar analistas:', error);
                addLog(`Erro ao cadastrar analistas: ${error.message}`, 'error');
                alert('Erro ao cadastrar analistas');
            }
        }
        
        async function syncWithFirebase() {
            if (!window.firebaseAppIntegration || !window.firebaseAppIntegration.initialized) {
                alert('Firebase n√£o est√° dispon√≠vel');
                return;
            }
            
            try {
                // Sincronizar analistas
                await window.firebaseAppIntegration.saveAnalysts();
                
                // Sincronizar estado
                if (window.portal) {
                    window.portal.saveLocalState();
                }
                
                addLog('Dados sincronizados com Firebase', 'success');
                alert('‚úÖ Dados sincronizados com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                addLog(`Erro na sincroniza√ß√£o: ${error.message}`, 'error');
                alert('Erro na sincroniza√ß√£o');
            }
        }
        
        function listAnalysts() {
            if (!window.portal || !window.portal.analysts) {
                alert('Sistema n√£o carregado');
                return;
            }
            
            const analysts = window.portal.analysts;
            let message = `Total de analistas: ${analysts.length}\n\n`;
            
            analysts.forEach(analyst => {
                message += `${analyst.name} (${analyst.level})\n`;
                message += `  Hor√°rio: ${analyst.startTime}h-${analyst.endTime}h\n`;
                message += `  Status: ${analyst.isAvailable ? 'Dispon√≠vel' : 'Indispon√≠vel'}\n`;
                message += `  Cliente Especial: ${analyst.specialClient || 'Nenhum'}\n`;
                message += `  Tickets hoje: ${analyst.ticketsHandled}\n`;
                message += `  Em atendimento: ${analyst.isBusy ? 'Sim' : 'N√£o'}\n`;
                if (analyst.currentTicket) {
                    message += `  Ticket atual: ${analyst.currentTicket}\n`;
                }
                message += '\n';
            });
            
            alert(message);
        }
        
        function resetQueueOrder() {
            if (confirm('Resetar ordem da fila?\n\nIsso resetar√° o √≠ndice de rota√ß√£o da fila.')) {
                localStorage.removeItem('queue_index');
                localStorage.removeItem('last_queue_index');
                addLog('Ordem da fila resetada', 'info');
                alert('‚úÖ Ordem da fila resetada!');
            }
        }
        
        // ============================================
        // SISTEMA DE LOGS
        // ============================================
        
        const systemLogs = [];
        
        function loadSystemInfo() {
            // Vers√£o
            document.getElementById('systemVersion').textContent = 'v4.0.0';
            
            // Status Firebase
            const firebaseStatus = window.firebaseAppIntegration ? 
                (window.firebaseAppIntegration.initialized ? '‚úÖ Conectado' : '‚ùå Offline') : 
                'N√£o carregado';
            document.getElementById('firebaseAdminStatus').textContent = firebaseStatus;
            
            // √öltimo backup
            const lastBackup = localStorage.getItem('last_backup_time');
            document.getElementById('lastBackupTime').textContent = lastBackup || 'Nunca';
            
            // Contador de analistas
            if (window.portal && window.portal.analysts) {
                document.getElementById('totalAnalystsCount').textContent = window.portal.analysts.length;
            }
        }
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            systemLogs.push({ timestamp, message, type });
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const container = document.getElementById('systemLogs');
            if (!container) return;
            
            let html = '';
            systemLogs.slice(-50).forEach(log => {
                html += `
                    <div class="log-entry">
                        <span class="log-time">[${log.timestamp}]</span>
                        <span class="log-message log-${log.type}">${log.message}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        // ============================================
        // FUN√á√ïES DE BACKUP
        // ============================================
        
        function createBackup() {
            try {
                // Coletar todos os dados
                const backupData = {
                    portalState: localStorage.getItem('portal_payhub_state'),
                    adminAuth: localStorage.getItem('admin_auth'),
                    adminUser: localStorage.getItem('admin_user'),
                    adminTime: localStorage.getItem('admin_time'),
                    queueIndex: localStorage.getItem('queue_index'),
                    lastQueueIndex: localStorage.getItem('last_queue_index'),
                    offlineTickets: localStorage.getItem('offline_tickets'),
                    backupTime: new Date().toISOString(),
                    version: '4.0.0'
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `backup_payhub_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                
                localStorage.setItem('last_backup_time', new Date().toLocaleString('pt-BR'));
                loadSystemInfo();
                
                addLog('Backup criado com sucesso', 'success');
                alert('‚úÖ Backup criado com sucesso!');
                
            } catch (error) {
                addLog(`Erro ao criar backup: ${error.message}`, 'error');
                alert('‚ùå Erro ao criar backup');
            }
        }
        
        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Selecione um arquivo de backup');
                return;
            }
            
            if (!confirm('ATEN√á√ÉO: Esta a√ß√£o substituir√° todos os dados atuais. Continuar?')) {
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validar backup
                    if (!backupData.backupTime || !backupData.version) {
                        throw new Error('Arquivo de backup inv√°lido');
                    }
                    
                    // Restaurar dados
                    if (backupData.portalState) {
                        localStorage.setItem('portal_payhub_state', backupData.portalState);
                    }
                    if (backupData.adminAuth) {
                        localStorage.setItem('admin_auth', backupData.adminAuth);
                    }
                    if (backupData.adminUser) {
                        localStorage.setItem('admin_user', backupData.adminUser);
                    }
                    if (backupData.adminTime) {
                        localStorage.setItem('admin_time', backupData.adminTime);
                    }
                    if (backupData.queueIndex) {
                        localStorage.setItem('queue_index', backupData.queueIndex);
                    }
                    if (backupData.lastQueueIndex) {
                        localStorage.setItem('last_queue_index', backupData.lastQueueIndex);
                    }
                    if (backupData.offlineTickets) {
                        localStorage.setItem('offline_tickets', backupData.offlineTickets);
                    }
                    
                    addLog(`Backup restaurado: ${backupData.backupTime}`, 'success');
                    alert('‚úÖ Backup restaurado com sucesso! Recarregue a p√°gina.');
                    
                } catch (error) {
                    addLog(`Erro ao restaurar backup: ${error.message}`, 'error');
                    alert('‚ùå Erro ao restaurar backup');
                }
            };
            
            reader.readAsText(file);
        }
        
        function exportData() {
            try {
                const portalState = localStorage.getItem('portal_payhub_state');
                const exportData = {
                    portalState: portalState ? JSON.parse(portalState) : null,
                    exportTime: new Date().toISOString(),
                    exportType: 'full_export',
                    version: '4.0.0'
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `dados_payhub_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                
                addLog('Dados exportados com sucesso', 'success');
                
            } catch (error) {
                addLog(`Erro ao exportar dados: ${error.message}`, 'error');
            }
        }
        
        // ============================================
        // FUN√á√ïES DE MANUTEN√á√ÉO
        // ============================================
        
        function clearLocalStorage() {
            if (!confirm('Limpar todo o cache local?\n\nIsso remover√° dados n√£o sincronizados.')) {
                return;
            }
            
            try {
                // Manter apenas autentica√ß√£o
                const adminAuth = localStorage.getItem('admin_auth');
                const adminUser = localStorage.getItem('admin_user');
                const adminTime = localStorage.getItem('admin_time');
                
                localStorage.clear();
                
                // Restaurar autentica√ß√£o
                if (adminAuth) localStorage.setItem('admin_auth', adminAuth);
                if (adminUser) localStorage.setItem('admin_user', adminUser);
                if (adminTime) localStorage.setItem('admin_time', adminTime);
                
                addLog('Cache local limpo', 'warning');
                alert('‚úÖ Cache limpo com sucesso!');
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                addLog(`Erro ao limpar cache: ${error.message}`, 'error');
            }
        }
        
        function reloadFirebase() {
            if (window.firebaseAppIntegration) {
                window.firebaseAppIntegration.init();
                addLog('Firebase recarregado', 'info');
                alert('Firebase sendo recarregado...');
            }
        }
        
        async function generateReport() {
            if (!window.firebaseAppIntegration || !window.firebaseAppIntegration.initialized) {
                alert('Firebase n√£o est√° dispon√≠vel para gerar relat√≥rios');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const startDate = prompt('Data inicial (YYYY-MM-DD):', today);
            const endDate = prompt('Data final (YYYY-MM-DD):', today);
            
            if (!startDate || !endDate) return;
            
            const includeAll = confirm('Incluir todos os tickets (n√£o apenas especiais)?');
            
            addLog(`Gerando relat√≥rio de ${startDate} at√© ${endDate}`, 'info');
            
            try {
                const csvContent = await window.firebaseAppIntegration.generateReport(
                    startDate,
                    endDate,
                    includeAll
                );
                
                if (!csvContent) {
                    alert('Nenhum ticket encontrado no per√≠odo selecionado');
                    return;
                }
                
                const filename = `relatorio_${startDate.replace(/-/g, '')}_${endDate.replace(/-/g, '')}.csv`;
                const success = window.firebaseAppIntegration.downloadCSV(csvContent, filename);
                
                if (success) {
                    addLog(`Relat√≥rio gerado com sucesso: ${filename}`, 'success');
                    alert(`‚úÖ Relat√≥rio gerado: ${filename}`);
                }
                
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                addLog(`Erro ao gerar relat√≥rio: ${error.message}`, 'error');
                alert('‚ùå Erro ao gerar relat√≥rio');
            }
        }
        
        // ============================================
        // FUN√á√ïES DE LOGS
        // ============================================
        
        function clearLogs() {
            systemLogs.length = 0;
            updateLogDisplay();
            addLog('Logs limpos', 'info');
        }
        
        function exportLogs() {
            const logText = systemLogs.map(log => 
                `[${log.timestamp}] ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `logs_payhub_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            addLog('Logs exportados', 'info');
        }
        
        // ============================================
        // FUN√á√ïES PERIGOSAS
        // ============================================
        
        function resetEverything() {
            if (!confirm('üö® RESETAR TUDO?\n\nEsta a√ß√£o √© IRREVERS√çVEL e ir√°:\n‚Ä¢ Apagar todos os dados locais\n‚Ä¢ Limpar todo o hist√≥rico\n‚Ä¢ Resetar o sistema para o estado inicial\n\nDigite "RESETAR" para confirmar:')) {
                return;
            }
            
            const confirmation = prompt('Digite "RESETAR" para confirmar:');
            if (confirmation !== 'RESETAR') {
                addLog('Reset cancelado pelo usu√°rio', 'warning');
                return;
            }
            
            // Limpar tudo
            localStorage.clear();
            sessionStorage.clear();
            
            addLog('Sistema completamente resetado', 'error');
            alert('‚úÖ Sistema resetado! Reiniciando...');
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
        
        function deleteAllData() {
            if (!confirm('üö® LIMPAR TODOS OS DADOS?\n\nEsta a√ß√£o tentar√° apagar todos os dados no Firebase.\nIsso pode n√£o ser revers√≠vel.\n\nDigite "APAGAR" para confirmar:')) {
                return;
            }
            
            const confirmation = prompt('Digite "APAGAR" para confirmar:');
            if (confirmation !== 'APAGAR') {
                addLog('Exclus√£o cancelada', 'warning');
                return;
            }
            
            addLog('Tentando limpar todos os dados...', 'warning');
            alert('‚ö†Ô∏è Esta funcionalidade requer implementa√ß√£o espec√≠fica no servidor.');
        }
    </script>
</body>
</html>
